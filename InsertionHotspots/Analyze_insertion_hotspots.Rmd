---
title: "Analyze_insertion_hotspots"
author: "bhaas"
date: '2022-10-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(GenomicRanges)
library(tidyverse)
library(pheatmap)
library(cowplot)
```

```{r}

hotspot_data = read.table("hotspots", header=T, sep="\t", stringsAsFactors = F)

# there's one 'hotspot' that was assigned to only one sample by nearest position. We'll eliminate that one because
# each insertion can only belong to one defined hotspot location, and a better one was found for its partner insertion.

hotspots = hotspot_data %>% select(sample, hotspot) %>% unique() %>% 
  group_by(hotspot) %>% tally() %>% filter(n > 1) %>%
  pull(hotspot)

hotspot_data = hotspot_data %>% filter(hotspot %in% hotspots)

length(hotspots)

```

```{r}
# incorporate TCGA sample type info

hotspot_data$TCGA = sapply(hotspot_data$sample, function(x) { str_split(x, "-")[[1]][1] })

```


```{r}

hotspot_sample_counts = hotspot_data %>% select(sample, hotspot) %>% unique() %>% 
  group_by(hotspot) %>% tally(name='num_samples') 

hotspot_sample_counts


```


```{r}
# get list of cancers represented at each hotspot

hotspot_to_cancer_type = hotspot_data %>% select(TCGA, hotspot) %>% unique() %>% group_by(hotspot) %>% arrange(TCGA) %>% mutate(tcga_set = paste(TCGA, collapse=",")) %>% select(hotspot, tcga_set) %>% unique()

hotspot_to_cancer_type 

hotspot_data %>% select(TCGA, hotspot) %>% unique() %>% group_by(hotspot) %>% arrange(TCGA) %>% mutate(tcga_set = paste(TCGA, collapse=",")) %>% group_by(tcga_set) %>% tally() %>% arrange(desc(n))
```







```{r}



hotspot_prevalence_counts = full_join(hotspot_to_cancer_type, hotspot_sample_counts) %>% 
  group_by(num_samples, tcga_set) %>% tally(name = 'prevalence_count')

hotspot_prevalence_counts

hotspot_prevalence_counts %>% ggplot(aes(x=num_samples, y=prevalence_count, fill=tcga_set)) + geom_col()


```


```{r}
# organize counts my virus groupings:

hotspot_to_virus_type = hotspot_data %>% select(virus_genome, hotspot) %>% 
  mutate(virus_genome = ifelse(grepl("HPV", virus_genome), "HPV", virus_genome) ) %>%
           unique() %>% group_by(hotspot) %>% arrange(virus_genome) %>% mutate(virus_set = paste(virus_genome, collapse=",")) %>% select(hotspot, virus_set) %>% unique()

hotspot_to_virus_type 
```

```{r}
hotspot_prevalence_counts = full_join(hotspot_to_virus_type, hotspot_sample_counts) %>% 
  group_by(num_samples, virus_set) %>% tally(name='prevalence_count')

hotspot_prevalence_counts

hotspot_prevalence_counts %>% ggplot(aes(x=num_samples, y=prevalence_count, fill=virus_set)) + geom_col()


```




# Examine expr and cnv stats for each hotspot.


```{r}

 hotspot_info = hotspot_data %>% select(sample, hotspot) %>% unique() %>% 
  group_by(hotspot) %>% tally(name='num_samples')  %>% 
  mutate(file_prefix = paste0(hotspot, '.', num_samples, 's'))


 hotspot_info
```






```{r}

analyze_expr_cnv_info = function(file_prefix) {
  cnv_expr_stats_file = paste0("hotspot_cnv_expr_partitioned_outputs/", 
                               file_prefix, '.both_cnv_n_expr.plot.enrichments_data.tsv')
  
  min_cnv_pval = NA
  min_expr_pval = NA
  
  if (file.exists(cnv_expr_stats_file) ) {
  
    cnv_expr_stats = read.table(cnv_expr_stats_file, header=T, sep="\t") 
    
    
    min_expr_pval = cnv_expr_stats %>% filter(type=='expr') %>% arrange(pval) %>% filter(row_number()==1) %>% pull(pval)
    
    if ('cnv' %in% cnv_expr_stats$type) {
      min_cnv_pval = cnv_expr_stats %>% filter(type=='cnv') %>% arrange(pval) %>% filter(row_number()==1) %>% pull(pval)
    }
    
  }
  
  ret_list = list("min_cnv_pval" = min_cnv_pval,
                  "min_expr_pval" = min_expr_pval)
  
  ret_list
  
  
}

```


```{r}
analyze_expr_cnv_info("chr14:68681967.12s")
```


```{r}

hotspot_stats = hotspot_info %>% rowwise() %>% mutate(expr_analysis = list(analyze_expr_cnv_info(file_prefix) ) ) %>%
  mutate(min_cnv_pval = expr_analysis$min_cnv_pval, min_expr_pval = expr_analysis$min_expr_pval )
                                                  

```


```{r}

hotspot_stats

```


# include fusion info

```{r}

hotspot_fusion_data = read.table("../TCGA_VIF_analysis/TCGA.insertions_mapped_to_fusions.at_hotspots.abridged.tsv", sep="\t", stringsAsFactors = F, header=T)

hotspots_w_host_fusions = hotspot_fusion_data %>% select(sample, hotspot) %>% unique() %>% group_by(hotspot) %>% tally(name='sample_count_w_fusion') %>% arrange(desc(sample_count_w_fusion))

hotspots_w_host_fusions

```






```{r}

hotspot_stats = hotspot_stats %>% mutate(sigCNV=-1*log10(min_cnv_pval), sigEXPR=-1*log10(min_expr_pval))

```



```{r}

hotspot_stats = left_join(hotspot_stats, hotspots_w_host_fusions)

hotspot_stats

```



```{r}
df = hotspot_stats %>% select(sigCNV, sigEXPR, sample_count_w_fusion, num_samples)

df = as.data.frame(df)
rownames(df) = hotspot_stats$hotspot

df[is.na(df)] = 0

```


```{r}

df[df>10] = 10

pheatmap(df)

```

# prioritize hotspots

```{r}

hotspot_stats[is.na(hotspot_stats) ] = 0

hotspot_stats =  hotspot_stats %>% mutate(priority = sigCNV + sigEXPR + sample_count_w_fusion)

prioritized_hotspots = hotspot_stats %>% arrange(desc(priority)) %>% pull(hotspot)

hotspot_stats$hotspot = factor(hotspot_stats$hotspot, levels=prioritized_hotspots)

```

```{r}

hotspot_stats = hotspot_stats %>% mutate(frac_w_fusion = sample_count_w_fusion / num_samples)


```

```{r}

fusion_sample_counts_plot = hotspot_stats %>% ggplot(aes(x=hotspot, y=sample_count_w_fusion)) + geom_col() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())

fusion_sample_counts_plot
```


```{r}

# count TCGA sample types by hotspot

 hotspot_TCGA_sample_counts = hotspot_data %>% select(sample, TCGA, hotspot) %>% unique() %>% 
  group_by(hotspot, TCGA) %>% tally(name='num_TCGA_samples') 


hotspot_TCGA_sample_counts
```


```{r}

hotspot_TCGA_sample_counts$hotspot = factor(hotspot_TCGA_sample_counts$hotspot, levels=prioritized_hotspots)

hotspot_TCGA_sample_count_plot = hotspot_TCGA_sample_counts %>% ggplot(aes(x=hotspot, y=num_TCGA_samples, fill=TCGA)) + geom_col() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())


hotspot_TCGA_sample_count_plot
```

```{r}

fusion_sample_fraction_plot = hotspot_stats %>% ggplot(aes(x=hotspot, y=frac_w_fusion)) + geom_col() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())

fusion_sample_fraction_plot
```



```{r}

num_samples_plot = hotspot_stats %>% ggplot(aes(x=hotspot, y=num_samples)) + geom_col() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())

num_samples_plot

```

```{r}

sigEXPR_plot = hotspot_stats %>% ggplot(aes(x=hotspot, y=sigEXPR)) + geom_col() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())

sigEXPR_plot
```


```{r}

sigCNV_plot = hotspot_stats %>% ggplot(aes(x=hotspot, y=sigCNV)) + geom_col() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())


sigCNV_plot 
```

```{r}

addSmallLegend <- function(myPlot, pointSize = 0.5, textSize = 3, spaceLegend = 0.1) {

    ## from: https://stackoverflow.com/questions/52297978/decrease-overal-legend-size-elements-and-text

    myPlot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize),
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}


```


```{r}

summary_plot = plot_grid(fusion_sample_fraction_plot, 
                         sigEXPR_plot, 
                         sigCNV_plot,
                         addSmallLegend(hotspot_TCGA_sample_count_plot) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(0.5))),
          ncol=1,
          align='v',
          axis='lr',
          rel_heights = c(0.1, 0.1, 0.1, 0.16)
          )

summary_plot
```

```{r}
ggsave(summary_plot, file="prioritized_insertions.summary_plot.pdf", width=10, height=4)
```

```{r}
write.table(hotspot_stats %>% arrange(desc(priority)) %>% select(-expr_analysis), file='hotspot_stats.tsv', quote=F, sep="\t", row.names = F)

```

# incorporate gene annotations for hotspots

```{r}

hotspot_stats = hotspot_stats %>% select(-expr_analysis)
```


```{r}

hotspot_gene_annots = tibble(read.table("__insertion_analysis/hotspot_gene_annots_Nov152022.txt", header=T, sep="\t", stringsAsFactors = F)) %>%
  select(-prev_hotspot_name)
#hotspot_gene_annots = hotspot_gene_annots %>% select(hotspot, genes_of_interest, fusions_of_interest, notes)


hotspot_gene_annots$chrom = sapply(hotspot_gene_annots$hotspot, function(x) { str_split(x, ":")[[1]][1]})

hotspot_gene_annots$coord = sapply(hotspot_gene_annots$hotspot, function(x) { as.numeric(str_split(x, ":")[[1]][2] ) })

hotspot_gene_annots = hotspot_gene_annots %>% rename(prev_hotspot_name = hotspot)


hotspot_stats$chrom = sapply(hotspot_stats$hotspot, function(x) { str_split(x, ":")[[1]][1]})
hotspot_stats$coord = sapply(hotspot_stats$hotspot, function(x) { as.numeric(str_split(x, ":")[[1]][2] ) })


gr_hotspot_stats = with(hotspot_stats, GRanges(chrom, IRanges(start=coord, end=coord)))
gr_hotspot_gene_annots = with(hotspot_gene_annots, GRanges(chrom, IRanges(start=coord, end=coord)))

nearest_indices = nearest(gr_hotspot_stats, gr_hotspot_gene_annots, ignore.strand=T)
annot_mapped_to_hotspot = data.frame(hotspot_gene_annots)[nearest_indices,]

hotspot_stats_mapped_annots = bind_cols(hotspot_stats, tibble(annot_mapped_to_hotspot) %>% select(prev_hotspot_name, genes_of_interest, notes))


```


```{r}

gene_annot_label_plot = hotspot_stats_mapped_annots %>% ggplot(aes(x=hotspot, y=0, label=genes_of_interest)) + geom_line()  + 
  geom_text(aes(angle=90, hjust=0), size=rel(1.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)))  +
  ylim(c(0,0.25)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank()) #, axis.line = element_line(colour = "black"))


gene_annot_label_plot

```


```{r}

summary_plot_w_geneannots = plot_grid(fusion_sample_fraction_plot, 
                         sigEXPR_plot, 
                         sigCNV_plot,
                         addSmallLegend(hotspot_TCGA_sample_count_plot),
                         gene_annot_label_plot + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(0.5))),
          ncol=1,
          align='v',
          axis='lr',
          rel_heights = c(0.1, 0.1, 0.1, 0.16, 0.1)
          )

summary_plot_w_geneannots


```

```{r}
ggsave(summary_plot_w_geneannots, file="prioritized_insertions.summary_plot.w_gene_annots.pdf", width=12, height=8)
```






