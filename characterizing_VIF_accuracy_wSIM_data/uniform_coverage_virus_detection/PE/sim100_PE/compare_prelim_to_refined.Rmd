---
title: "compare prelim to refined insertions"
author: "Brian Haas"
date: "11/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```



```{r}

prelim_TP_FP = read.table("prelim_insertion_mappings.tsv.called_preds", sep="\t", header=T, stringsAsFactors = F)
prelim_TP_FP$type='prelim'

refined_TP_FP = read.table("refined_insertion_mappings.tsv.called_preds", sep="\t", header=T, stringsAsFactors = F)
refined_TP_FP$type='refined'

TP_FP_data = bind_rows(prelim_TP_FP, refined_TP_FP)

```


# Examine TP and FP counts vs. min read evidence threshold

```{r}


TP_FP_data = TP_FP_data %>% gather(key='TP_or_FP', value='count', num_TP, num_FP)

TP_FP_data

```
```{r}


NUM_TRUTH_ENTRIES = nrow(read.table(gzfile("data/insertion_truth_set.tsv.gz"), header=T))

TP_FP_data %>% ggplot(aes(x=min_reads, y=count, fill=TP_or_FP)) + geom_col() + facet_wrap(~type) + 
    geom_abline(intercept=NUM_TRUTH_ENTRIES, slope=0, color='black')

```

```{r}

TP_FP_data %>% filter(type=='prelim') %>% ggplot(aes(x=min_reads, y=count, fill=TP_or_FP)) + geom_col() + geom_abline(intercept=NUM_TRUTH_ENTRIES, slope=0, color='black')



```



# Examine sensitivity per virus


```{r}

prelim_insertions_per_virus = read.table("prelim_insertion_mappings.tsv.TP_called_per_virus", sep="\t", header=T, stringsAsFactors = F)

```

```{r}

prelim_insertions_per_virus %>% group_by(min_reads, sum_found) %>% tally() %>%
    ggplot(aes(x=sum_found, y=n, color=min_reads, group=min_reads)) + geom_line()

```


Most of the viruses, we're capturing 8 to all 10 of the 10 sim insertions each.  There are however some viruses that we have little detection capability for.


# Examine sensitivity for HPV strains

```{r}


prelim_insertions_per_virus %>% filter(grepl("HPV", vir_chr)) %>% ggplot(aes(y=sum_found, x=min_reads, group=vir_chr, color=vir_chr)) + theme(legend.position = "none") + geom_jitter(width=0.1, height=0.1) +  ggtitle("214 HPV isolates insertion sensitivity ~ min evidence reads")



```


Are there viruses that appear to be recalcitrant to our approach?

```{r}
prelim_insertions_per_virus %>% filter(min_reads==5)  %>% arrange(sum_found) %>% ggplot(aes(x=reorder(vir_chr, sum_found), y=sum_found)) + geom_point()

```




```{r}

prelim_insertions_per_virus %>% filter(min_reads==5) %>% arrange(sum_found)


```





Compare read support from prelim and refined

```{r}

refined_data = read.table(gzfile("data/refined_results.agg.tsv.gz"), header=T, com='', sep="\t", stringsAsFactors = F)

```


```{r}

smoothScatter(refined_data %>% filter(is_primary != "False") %>% select(prelim.total, total), xlim=c(0,200))
abline(a=0,b=1, col='red')

```


# precision/recall plots

```{r}

get_TP_FP_per_virus = function(file_prefix) {
    
    TP_per_virus_fname = paste0(file_prefix, ".TP_called_per_virus")
    FP_per_virus_fname = paste0(file_prefix, ".FP_per_virus")
    
    TP_per_virus = read.table(TP_per_virus_fname, header=T, sep="\t", stringsAsFactors = F) %>% rename(TP = sum_found)
    FP_per_virus = read.table(FP_per_virus_fname, header=T, sep="\t", stringsAsFactors = F) %>% rename(FP = n)
    
    TP_FP_per_virus = full_join(TP_per_virus, FP_per_virus, by=c('min_reads', 'vir_chr'))
}


```


```{r}

prelim_TP_FP_data = get_TP_FP_per_virus("prelim_insertion_mappings.tsv") %>% mutate(type='prelim')
refined_TP_FP_data = get_TP_FP_per_virus("refined_insertion_mappings.tsv") %>% mutate(type='refined')

# merge prelim and refined
accuracy_data = bind_rows(prelim_TP_FP_data, refined_TP_FP_data)

accuracy_stats = accuracy_data %>% group_by(min_reads, type) %>% 
    summarize(sum_FP = sum(FP, na.rm = T), sum_TP = sum(TP, na.rm=T))  %>% 
    mutate(recall=sum_TP/NUM_TRUTH_ENTRIES, precision = sum_TP/(sum_TP + sum_FP)) %>%
    mutate(F1= (2*precision*recall)/(precision+recall) ) 


```
```{r}

accuracy_stats %>% 
    ggplot(aes(x = recall, y = precision, color=type)) +
    geom_point() + geom_line(aes(groups=type)) # +
    #geom_text(aes(label=min_reads),hjust=0, vjust=0) + 
    #facet_wrap(~type)


```
```{r}
accuracy_stats %>% 
    ggplot(aes(x = min_reads, y = F1, color=type)) +
    geom_point() + geom_line(aes(groups=type)) # +
    #geom_text(aes(label=min_reads),hjust=0, vjust=0) + 
    #facet_wrap(~type)
```




# Examine consistency of evidence read counts with known counts


```{r}

known_counts = read.table("data/frag_evidence_counts.tsv", header=T, sep="\t", stringsAsFactors = F)

```

```{r}
prelim_TP_entries = read.table("prelim_insertion_mappings.tsv.indic_within_range.best_per_vir_brkend_grp", header=T, sep="\t", stringsAsFactors = F)
prelim_TP_entries = full_join(prelim_TP_entries, known_counts, by=c('truth_insertion_name'='insertion'))

cor(prelim_TP_entries$frag_count, prelim_TP_entries$total_reads, use='complete')

smoothScatter(prelim_TP_entries$frag_count, prelim_TP_entries$total_reads, ylim=c(0,200))
abline(a=0, b=1)

```




```{r}


refined_TP_entries = read.table("refined_insertion_mappings.tsv.indic_within_range.best_per_vir_brkend_grp", header=T, sep="\t", stringsAsFactors = F)
refined_TP_entries = full_join(refined_TP_entries, known_counts, by=c('truth_insertion_name'='insertion'))

cor(refined_TP_entries$frag_count, refined_TP_entries$total_reads, use='complete')

smoothScatter(refined_TP_entries$frag_count, refined_TP_entries$total_reads)
abline(a=0, b=1)

```

# What TP calls dropped from refined and why?


```{r}

# restrict to min reads 5

prelim_TP_per_virus = read.table("prelim_insertion_mappings.tsv.TPs_each_min_read_threshold", header=T, sep="\t", stringsAsFactors = F) %>% filter(min_reads == 5)

refined_TP_per_virus = read.table("refined_insertion_mappings.tsv.TPs_each_min_read_threshold", header=T, sep="\t", stringsAsFactors = F) %>% filter(min_reads == 5)

```

```{r}

prelim_found = prelim_TP_per_virus %>% select(truth_insertion_name) %>% unique() %>% pull(truth_insertion_name)

refined_found = refined_TP_per_virus %>% select(truth_insertion_name) %>% unique() %>% pull(truth_insertion_name)

in_prelim_missing_refined = prelim_TP_per_virus %>% filter(! truth_insertion_name %in% refined_found)

```

```{r}
#in_prelim_missing_refined %>% filter(grepl("B26:", virus_brkend_grp))

in_prelim_missing_refined 

```




