---
title: "compare_VIF_to_published_NatGenet2015"
author: "bhaas"
date: '2023-03-01'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
```


```{r}

BINSIZE = 10

```

```{r}

published_WGS_insertions = read.table("../../NatGenetics2015_reanalysis_published_data/data/TableS3.WGS_insertion_sites.txt", 
                                      header=T, sep="\t", stringsAsFactors = F) %>% 
  mutate(pub_total = J_reads + S_reads)

nrow(published_WGS_insertions)

```



```{r}

published_WGS_insertions = published_WGS_insertions %>% mutate(bin = round(hg38_Coord / BINSIZE)) %>% 
  group_by(hg38_Chrom, bin) %>% arrange(desc(pub_total)) %>% filter(row_number() == 1) %>% ungroup() %>% 
  select(-bin)

nrow(published_WGS_insertions)

```


```{r}

vif_HIVID_insertions = read.table("../insertions.tsv", header=T, sep="\t", stringsAsFactors = F) %>% filter(sample_type == "hivid")

vif_HIVID_insertions$sample_id = sapply(vif_HIVID_insertions$sample_label, function(x) { str_split(x, "-")[[1]][4]})

nrow(vif_HIVID_insertions)

```

```{r}

vif_HIVID_insertions = vif_HIVID_insertions %>% mutate(bin = round(human_coord / BINSIZE) ) %>% 
  group_by(humanchr, bin) %>% arrange(desc(total)) %>% filter(row_number() == 1) %>% ungroup() %>% 
  select(-bin)

nrow(vif_HIVID_insertions)


```



```{r}

sample_ids = intersect(published_WGS_insertions %>% select(sample_id) %>% unique() %>% pull(sample_id),
                       vif_HIVID_insertions %>% select(sample_id) %>% unique() %>% pull(sample_id))

length(sample_ids)


sample_ids
```


```{r}

df_A_with_nearest_df_B = function(df_A, df_B) {
  
    # each df requires fields:  Chromosome_val, Start_val, End_val
  
    gr_df_A = with(df_A, GRanges(Chromosome_val,
                                IRanges(start=Start_val, end=End_val)))
    
    gr_df_B = with(df_B, GRanges(Chromosome_val,
                                IRanges(start=Start_val, end=End_val)))

  
    nearest_df_B = df_B[nearest(gr_df_A, gr_df_B, ignore.strand=T),]
    
    df_A_with_nearest_df_B = bind_cols(df_A %>% select(-Chromosome_val, -Start_val, -End_val), 
                                       nearest_df_B %>% select(-Chromosome_val, -Start_val, -End_val))
    
    return(df_A_with_nearest_df_B)

}



```






```{r}

vif_with_nearest_published = NULL

published_with_nearest_prelim = NULL

for (selected_sample_id in sample_ids) {
  
  published_WGS_insertions_for_sample = published_WGS_insertions %>% filter(sample_id == selected_sample_id) %>%
    mutate(Chromosome_val = hg38_Chrom, Start_val = hg38_Coord, End_val = hg38_Coord)
  
  vif_HIVID_insertions_for_sample = vif_HIVID_insertions %>% filter(sample_id == selected_sample_id) %>% select(-sample_id) %>%
    mutate(Chromosome_val = humanchr, Start_val = human_coord, End_val = human_coord)
  

  vif_with_nearest_published = bind_rows(vif_with_nearest_published, 
                                            df_A_with_nearest_df_B(vif_HIVID_insertions_for_sample, published_WGS_insertions_for_sample) )
  
  
  published_with_nearest_prelim = bind_rows(published_with_nearest_prelim,
                                            df_A_with_nearest_df_B(published_WGS_insertions_for_sample, vif_HIVID_insertions_for_sample))
  
}


```



```{r}

vif_with_nearest_published = vif_with_nearest_published %>% mutate(delta = abs(hg38_Coord - human_coord))


published_with_nearest_prelim = published_with_nearest_prelim %>% mutate(delta = abs(hg38_Coord - human_coord))

```


```{r}

AGREE_DIST_RANGE = 100

vif_with_nearest_published  = vif_with_nearest_published  %>% mutate(within_range = delta <= AGREE_DIST_RANGE)

published_with_nearest_prelim  = published_with_nearest_prelim  %>% mutate(within_range = delta <= AGREE_DIST_RANGE)


```


```{r}
## Examine fraction of prelim insertions that agree

min_read_supports = c(1, 2, 5, 10, 20, 50) 

vif_with_nearest_published_min_support_df = NULL

for (min_read_support in min_read_supports) {
  
  vif_with_nearest_published_min_reads = vif_with_nearest_published  %>% filter(total >= min_read_support)
  
  num_insertions = nrow(vif_with_nearest_published_min_reads)
  num_agree = nrow(vif_with_nearest_published_min_reads %>% filter(within_range))
  frac_agree = num_agree / num_insertions
  
  vif_with_nearest_published_min_support_df = bind_rows(vif_with_nearest_published_min_support_df, 
                                                           data.frame(min_read_support=min_read_support, 
                                                                      num_insertions = num_insertions,
                                                                      num_agree = num_agree,
                                                                      frac_agree = frac_agree))
  
}
  

vif_with_nearest_published_min_support_df

```


```{r}


published_with_nearest_vif_min_support_df = NULL

for (min_read_support in min_read_supports) {
  
  published_with_nearest_vif_min_reads = published_with_nearest_prelim  %>% filter(pub_total >= min_read_support)
  
  num_insertions = nrow(published_with_nearest_vif_min_reads)
  num_agree = nrow(published_with_nearest_vif_min_reads %>% filter(within_range))
  frac_agree = num_agree / num_insertions
  
  published_with_nearest_vif_min_support_df = bind_rows(published_with_nearest_vif_min_support_df, 
                                                           data.frame(min_read_support=min_read_support, 
                                                                      num_insertions = num_insertions,
                                                                      num_agree = num_agree,
                                                                      frac_agree = frac_agree))
  
}
  

published_with_nearest_vif_min_support_df


```

```{r}


published_with_nearest_prelim %>% 
  filter(within_range) %>%
  ggplot(aes(x=pub_total, y=total)) + geom_point() +
  geom_abline(slope=1, intercept=0, color='red') +
  xlim(0,1000) + ylim(0,1000)



```


```{r}

published_with_nearest_prelim %>% 
  filter(within_range) %>%
  mutate(count_delta = total - pub_total) %>%
  ggplot() + 
  geom_boxplot(aes(x=count_delta))


```

```{r}

totals = published_with_nearest_prelim %>% 
  filter(within_range) %>%
  select(total, pub_total)

cor.test(totals$total, totals$pub_total)


```


Subset experimentally validated?

Restrict to Agreement among rnaseq and hyb?



