---
title: "compare_VIF_to_published_NatGenet2015"
author: "bhaas"
date: '2023-03-01'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
```


```{r}

BINSIZE = 1000

```

```{r}

published_insertions = read.table("../../NatGenetics2015_reanalysis_published_data/data/TableS6.SangerValidations.wHg38_liftover.tsv", header=T, sep="\t", stringsAsFactors = F) 

published_insertions$hg38_Chrom = sapply(published_insertions$hg38_liftover, function(x) { str_split(x, ":")[[1]][1] } )
published_insertions$hg38_Coord = sapply(published_insertions$hg38_liftover, function(x) { str_split(x, "-")[[1]][2] } )

published_insertions$hg38_Coord = as.numeric(published_insertions$hg38_Coord)



cnames = colnames(published_insertions)
cnames[1] = 'sample_id'
colnames(published_insertions) = cnames

published_insertions = published_insertions %>% 
  mutate(sample_id = toupper(sample_id)) %>% 
  mutate(sample_id = ifelse(sample_id == "CASKI", "CASKID", sample_id))


nrow(published_insertions)

# 175
```


```{r}

# merge with info from full set of published insertions:
all_published_insertions_info =  read.table("../../NatGenetics2015_reanalysis_published_data/data/TableS5.w_Hg38.tsv", header=T, sep="\t", stringsAsFactors = F)  %>%
  select(sample_id, hg38_Chrom, hg38_Coord, pub_total = total, found_by_WGS ) %>% filter(! is.na(hg38_Coord)) %>% 
  mutate(sample_id = toupper(sample_id)) %>% 
  mutate(sample_id = ifelse(sample_id == "CASKI", "CASKID", sample_id))

published_insertions = left_join(published_insertions, all_published_insertions_info, 
                                 by=c('sample_id', 'hg38_Chrom', 'hg38_Coord') )

nrow(published_insertions
     )

# 175
```



```{r}

# distill to insertion loci

published_insertions = published_insertions %>% mutate(bin = round(hg38_Coord / BINSIZE)) %>% 
  group_by(sample_id, hg38_Chrom, bin) %>% arrange(desc(pub_total)) %>% filter(row_number() == 1) %>% ungroup() %>% 
  select(-bin)

nrow(published_insertions)

# 127

```


```{r}

vif_insertions = read.table("../insertions.tsv", header=T, sep="\t", stringsAsFactors = F) %>%
  filter(sample_type == "hivid") 

#vif_insertions$sample_id = sapply(vif_insertions$sample_label, function(x) { str_split(x, "-")[[1]][4]})
vif_insertions = vif_insertions %>% mutate(sample_id = sample_label_short)

nrow(vif_insertions)

# 17928

```

```{r}
# convert to insertion loci

vif_insertions = vif_insertions %>% mutate(bin = round(human_coord / BINSIZE) ) %>% 
  group_by(sample_id, humanchr, bin) %>% arrange(desc(total)) %>% filter(row_number() == 1) %>% ungroup() %>% 
  select(-bin)


nrow(vif_insertions)

# 16899

```



```{r}


published_insertions_sample_ids = published_insertions %>% select(sample_id) %>% unique() %>% pull(sample_id)

message("published sample_ids with insertions: ", length(published_insertions_sample_ids))
# 52

vif_insertions_sample_ids = vif_insertions %>% select(sample_id) %>% unique() %>% pull(sample_id)

message("vif sample_ids with insertions: ", length(vif_insertions_sample_ids) )
# 125

sample_ids_common = intersect(published_insertions_sample_ids,
                       vif_insertions_sample_ids)

message("num sample_ids in common: ", length(sample_ids_common))
# 51

message("samples missing from vif but in published ", paste(setdiff( published_insertions_sample_ids, vif_insertions_sample_ids), collapse=' '))
# 512

message("those sample_ids in published but not in vif: ", paste(setdiff(published_insertions_sample_ids, vif_insertions_sample_ids), collapse=" ") )
# 512

## missing S12 in hivid for vif

```

```{r}
# restrict samples analyzed to those in common:

vif_insertions = vif_insertions %>% filter(sample_id %in% sample_ids_common)
message("count vif insertions among common samples: ", nrow(vif_insertions))
# 7077

published_insertions= published_insertions %>% filter(sample_id %in% sample_ids_common)
message("count published insertions among common samples: ", nrow(published_insertions))
# 125

```





```{r}

df_A_with_nearest_df_B = function(df_A, df_B) {
  
    # each df requires fields:  Chromosome_val, Start_val, End_val
  
    gr_df_A = with(df_A, GRanges(Chromosome_val,
                                IRanges(start=Start_val, end=End_val)))
    
    gr_df_B = with(df_B, GRanges(Chromosome_val,
                                IRanges(start=Start_val, end=End_val)))

  
    nearest_df_B = df_B[nearest(gr_df_A, gr_df_B, ignore.strand=T),]
    
    df_A_with_nearest_df_B = bind_cols(df_A %>% select(-Chromosome_val, -Start_val, -End_val), 
                                       nearest_df_B %>% select(-Chromosome_val, -Start_val, -End_val))
    
    return(df_A_with_nearest_df_B)

}



```






```{r}



published_with_nearest_vif = NULL

for (selected_sample_id in sample_ids_common) {
  
  published_insertions_for_sample = published_insertions %>% filter(sample_id == selected_sample_id) %>%
    mutate(Chromosome_val = hg38_Chrom, Start_val = hg38_Coord, End_val = hg38_Coord)
  
  vif_insertions_for_sample = vif_insertions %>% filter(sample_id == selected_sample_id) %>% select(-sample_id) %>%
    mutate(Chromosome_val = humanchr, Start_val = human_coord, End_val = human_coord)
  
  
  published_with_nearest_vif = bind_rows(published_with_nearest_vif,
                                            df_A_with_nearest_df_B(published_insertions_for_sample, vif_insertions_for_sample))
  
}


```



```{r}


published_with_nearest_vif = published_with_nearest_vif %>% mutate(delta = abs(hg38_Coord - human_coord))

```


```{r}

AGREE_DIST_RANGE = BINSIZE


published_with_nearest_vif  = published_with_nearest_vif  %>% mutate(within_range = delta <= AGREE_DIST_RANGE)


```





```{r}


min_read_supports = seq(10)

published_with_nearest_vif_min_support_df = NULL

for (min_read_support in min_read_supports) {
  
  published_with_nearest_vif_min_reads = published_with_nearest_vif  %>% filter(pub_total >= min_read_support)
  
  num_insertions = nrow(published_with_nearest_vif_min_reads)
  num_agree = nrow(published_with_nearest_vif_min_reads %>% filter(within_range))
  frac_agree = num_agree / num_insertions
  
  published_with_nearest_vif_min_support_df = bind_rows(published_with_nearest_vif_min_support_df, 
                                                           data.frame(min_read_support=min_read_support, 
                                                                      num_insertions = num_insertions,
                                                                      num_agree = num_agree,
                                                                      frac_agree = frac_agree))
  
}
  

published_with_nearest_vif_min_support_df

# 92 agree
# 92/127 = 72%
```

```{r}


published_with_nearest_vif %>% 
  filter(within_range) %>%
  ggplot(aes(x=pub_total, y=total)) + geom_point() +
  geom_abline(slope=1, intercept=0, color='red') 
#+
#  xlim(0,1000) + ylim(0,1000)



```


```{r}

published_with_nearest_vif %>% 
  filter(within_range) %>%
  mutate(count_delta = total - pub_total) %>%
  ggplot() + 
  geom_boxplot(aes(x=count_delta))


```

```{r}

totals = published_with_nearest_vif %>% 
  filter(within_range) %>%
  select(total, pub_total)

cor.test(totals$total, totals$pub_total)

# R=0.92

```

```{r}


published_with_nearest_vif %>% select(sample_id, humanchr, hg38_Coord, human_coord, delta, within_range, pub_total) %>%
  filter(pub_total >= 5) %>%
  arrange(sample_id, humanchr, hg38_Coord) 


```

```{r}

p = published_with_nearest_vif %>% 
  filter(within_range) %>%
  ggplot(aes(x=pub_total, y=total)) + geom_point() +
  geom_abline(slope=1, intercept=0, color='red') #+
  #xlim(0,1000) + ylim(0,1000)

# include those not validated

p = p + geom_point(data=published_with_nearest_vif %>% filter(! within_range), aes(x=pub_total, y=0), color='red') +
  xlab("NatGen2015-SangerValidated") + ylab("ctat-VIF")

p

```

