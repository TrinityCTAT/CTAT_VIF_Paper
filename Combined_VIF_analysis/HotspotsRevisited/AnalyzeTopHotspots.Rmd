---
title: "AnalyzeHotspots"
author: "bhaas"
date: '2023-03-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)

```



```{r}


insertions_data = read.table("../DecorateInsertions/all_insertions_and_virus_content_merged.FILTERED.Decorated.tsv", header=T, sep="\t", stringsAsFactors = F)


```


```{r}

MIN_HOTSPOT_SIZE = 9

insertions_data = insertions_data %>% filter(hotspot_participant_count >= MIN_HOTSPOT_SIZE)

```


```{r}

insertions_data %>% select(hotspot) %>% unique() %>% nrow()

```


```{r}

# massaging data

## rename viruses
insertions_data = insertions_data %>% mutate(virus = ifelse(grepl("Barr", virus), "EBV", virus)) %>%
  mutate(virus = ifelse(grepl("XMRV|urine", virus), "MLV", virus))

## take single best (participant, virus, seqtype) per hotspot
insertions_data = insertions_data %>% group_by(hotspot, participant, virus, seqtype) %>% 
  arrange(desc(total_rpm)) %>% filter(row_number()==1) %>% 
  ungroup()


```




```{r}

ordered_hotspots = insertions_data %>% select(hotspot, hotspot_participant_count) %>% unique() %>%   
  arrange(desc(hotspot_participant_count)) %>% select(hotspot) %>% unique() %>% pull(hotspot)


insertions_data$hotspot = factor(insertions_data$hotspot, levels=ordered_hotspots)
  
```



# virus representation at hotspots


```{r}


hotspot_virus_representation = insertions_data %>% select(hotspot, virus, participant) %>% unique() %>% group_by(hotspot, virus) %>% tally(name='hotspot_virus_count')


hotspot_virus_representation %>% 
  ggplot(aes(x=hotspot, y=hotspot_virus_count, fill=virus)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))


hotspot_by_virus_plot = hotspot_virus_representation %>% 
  mutate(virus= ifelse(grepl("HPV", virus), "HPV", virus)) %>%
  ggplot(aes(x=hotspot, y=hotspot_virus_count, fill=virus)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

hotspot_by_virus_plot

```

# hotspot seqtype info

```{r}

hotspot_seqtype_frac_info = insertions_data %>% select(hotspot, participant, seqtype) %>% unique() %>%
     group_by(hotspot, seqtype) %>% tally(name='hotspot_seqtype_counts') %>% mutate(hotspot_seqtype_frac=prop.table(hotspot_seqtype_counts)) 

hotspot_seqtype_frac_info
```







```{r}


hotspot_by_seqtype_plot = hotspot_seqtype_frac_info %>% ggplot(aes(x=hotspot, y=hotspot_seqtype_frac, fill=seqtype)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

 hotspot_by_seqtype_plot 
  
```
  
  
```{r}
#  cohort representation

hotspot_cohort_frac_info = insertions_data %>% 
  select(hotspot, participant, cohort) %>% unique() %>%
  group_by(hotspot, cohort) %>% tally(name='hotspot_cohort_counts') %>% mutate(hotspot_cohort_frac=prop.table(hotspot_cohort_counts)) 

hotspot_cohort_frac_info

  
```







```{r}

hotspot_by_cohort_plot = hotspot_cohort_frac_info %>% ggplot(aes(x=hotspot, y=hotspot_cohort_frac, fill=cohort)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

hotspot_by_cohort_plot

```


```{r}

hotspot_project_frac_info = insertions_data %>% 
  select(hotspot, participant, cohort, project) %>% unique() %>%
  group_by(hotspot, cohort, project) %>% tally(name='hotspot_cohort_project_counts') %>% mutate(hotspot_cohort_project_frac=prop.table(hotspot_cohort_project_counts)) 

hotspot_project_frac_info


```



```{r}


pg = plot_grid(
          hotspot_by_seqtype_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_by_cohort_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_by_virus_plot, 
          ncol = 1, align='v',
          rel_heights=c(0.15, 0.15, 0.5))

pg
```

```{r}

ggsave(pg, file="top_hotspots_by_attributes.pdf", width=12, height=15)

```

#######################################
# Incorporate expression and CNV info
#######################################


```{r}

hotspot_cnv_boxplot = insertions_data %>% ggplot(aes(x=hotspot, y=copy_number)) + geom_boxplot() +
  geom_hline(yintercept=2, linetype=2, color='purple') +
   theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(trans='log10')

hotspot_cnv_boxplot 

```

# Incorporate expression effects


```{r}

hotspot_expr_quantile_plot = insertions_data %>% ggplot(aes(x=hotspot, y=expr_quantile)) + geom_boxplot() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

hotspot_expr_quantile_plot
```



```{r}
# Bring all the plots together.

pg2 = plot_grid(
          hotspot_by_seqtype_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_by_cohort_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_cnv_boxplot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          hotspot_expr_quantile_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          hotspot_by_virus_plot, 
          ncol = 1, 
          align='v',
          axis='lr',
          rel_heights=c(0.15, 0.15, 
                        0.1,
                        0.1, 
                        0.5
                        ))

pg2
```

```{r}

ggsave(pg2, file="hotspot_summary_plot.pdf", width=20, height=15)


```



# examine virus representation among the different project cohorts


```{r}


ccle_virus_data = insertions_data %>% filter(cohort=='CCLE') %>%
  select(hotspot, virus, participant) %>% unique() %>% group_by(hotspot, virus) %>% tally(name='num_participants')
  

ccle_virus_rep_plot =   ccle_virus_data %>%  ggplot(aes(x=hotspot, y=virus, fill=num_participants)) + geom_tile() + ggtitle("CCLE")  +
  scale_fill_gradient(low="lightblue", high="black", na.value = 'white') 

ccle_virus_rep_plot + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}

tcga_virus_data =  insertions_data %>% filter(cohort=='TCGA') %>%
  select(hotspot, virus, participant) %>% unique() %>% group_by(hotspot, virus) %>% tally(name='num_participants')
  

tcga_virus_rep_plot = tcga_virus_data %>% 
  ggplot(aes(x=hotspot, y=virus, fill=num_participants)) + geom_tile() + ggtitle("TCGA")  +
  scale_fill_gradient(low="lightblue", high="black", na.value = 'white') 

tcga_virus_rep_plot  + theme(axis.text.x = element_text(angle = 90, hjust = 1))


```





```{r}

gtex_virus_data  = insertions_data %>% filter(cohort=='GTEx') %>%
  select(hotspot, virus, project, participant) %>% unique() %>% 
  mutate(virus_projname = paste(virus, project)) %>%
  group_by(hotspot, virus_projname) %>% tally(name='num_participants')
  

gtex_virus_rep_plot =  gtex_virus_data %>%  ggplot(aes(x=hotspot, y=virus_projname, fill=num_participants)) + geom_tile() + ggtitle("GTEx")  +
  scale_fill_gradient(low="lightblue", high="black", na.value = 'white') 

gtex_virus_rep_plot +  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


```{r}

natgen_virus_data = insertions_data %>% filter(cohort=='NATGEN2015') %>%
  select(hotspot, virus, participant) %>% unique() %>% 
  group_by(hotspot, virus) %>% tally(name='num_participants')


natgen_virus_rep_plot = natgen_virus_data %>% ggplot(aes(x=hotspot, y=virus, fill=num_participants)) + geom_tile() + ggtitle("NATGEN2015")  +
  scale_fill_gradient(low="lightblue", high="black", na.value = 'white') 


natgen_virus_rep_plot +  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```



```{r}

# Curie hybcap data 

curie_virus_data = insertions_data %>% filter(cohort=='Curie') %>%
  select(hotspot, virus, project, participant) %>% unique() %>% 
  mutate(virus_projname = paste(virus, project)) %>%
  group_by(hotspot, virus_projname) %>% tally(name='num_participants')



curie_virus_rep_plot = curie_virus_data %>% ggplot(aes(x=hotspot, y=virus, fill=num_participants)) + geom_tile() + ggtitle("Curie")  +
  scale_fill_gradient(low="lightblue", high="black", na.value = 'white') 


curie_virus_rep_plot +  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```




```{r}

pg4 = plot_grid(
          gtex_virus_rep_plot  + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          ccle_virus_rep_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
           natgen_virus_rep_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          curie_virus_rep_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          tcga_virus_rep_plot +  theme(axis.text.x = element_text(angle = 90, hjust = 1)),
          ncol = 1, 
          align='v',
          axis='lr',
          rel_heights=c(0.1,
                        0.1,
                        0.1, 
                        0.1,
                        0.3
                        ))

pg4

```



```{r}

ggsave(pg4, file="virus_cohort_representation.pdf", width=25, height=15)


```



