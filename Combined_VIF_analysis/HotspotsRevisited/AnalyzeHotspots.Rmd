---
title: "AnalyzeHotspots"
author: "bhaas"
date: '2023-03-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)

```


# parse inputs

```{r}
HOTSPOT_WINSIZE = "1e5"
```


```{r}

hotspot_info = read.table( paste0("plot.hotspots.win_", HOTSPOT_WINSIZE, ".tsv.w_20_neighbors.hotspot_virus_sample_counts.tsv"), header=T, sep="\t", stringsAsFactors = F)

head(hotspot_info)

```

```{r}

hotspot_insertions = read.table(paste0("hotspots.win_", HOTSPOT_WINSIZE, ".tsv.w_20_neighbors"), 
                                header=T, sep="\t", stringsAsFactors = F)

head(hotspot_insertions)
```


```{r}

insertion_hotspot_assignments = read.table(paste0("hotspots.win_", HOTSPOT_WINSIZE, ".tsv"), header=T, sep="\t", stringsAsFactors = F)

head(insertion_hotspot_assignments)
```



# begin analysis


```{r}

hotspot_info %>% select(hotspot) %>% unique() %>% nrow()

```

```{r}

hotspot_sum_sample_virus_counts = hotspot_info %>% select(hotspot_name, virus_genome, hotspot_virus_tally) %>% group_by(hotspot_name) %>% summarize(sum_sample_viruses = sum(hotspot_virus_tally)) %>% arrange(desc(sum_sample_viruses)) %>% ungroup()

hotspot_sum_sample_virus_counts

```


```{r}

hotspot_sum_sample_virus_counts %>% ggplot(aes(x=reorder(hotspot_name, -1*sum_sample_viruses), sum_sample_viruses)) + geom_col() +
  ggtitle("sum(virus,sample) ranked hotspots") +
   scale_y_continuous(trans='log10')


```

```{r}

hotspot_sum_sample_virus_counts  %>% group_by(sum_sample_viruses) %>% tally()


```

```{r}

hotspot_sum_sample_virus_counts  %>% group_by(sum_sample_viruses) %>% tally() %>%
  ggplot(aes(x=as.factor(sum_sample_viruses), y=n)) + geom_col() +
  ggtitle("Number of hotspots with number of sample/viruses at sites") +
  xlab("number of sample/viruses at site") + ylab("number of hotspots")

```

```{r}


p = hotspot_sum_sample_virus_counts  %>% group_by(sum_sample_viruses) %>% tally() %>%
  ggplot(aes(x=as.factor(sum_sample_viruses), y=n)) + geom_col() +
  ggtitle("Number of hotspots with number of sample/viruses at sites") +
  xlab("number of sample/viruses at site") + ylab("number of hotspots") +
  scale_y_continuous(trans='log10')

p
```

```{r}
# include random data:

random_hotspot_data = read.table(gzfile(paste0("data/rand_cluster_size_counts.win_",  HOTSPOT_WINSIZE, ".tsv.gz")), header=F, sep="\t")

colnames(random_hotspot_data) = c('trial', 'hotspot_size', 'num_hotspots')

random_hotspot_data = random_hotspot_data %>% filter(hotspot_size >= 3)


```

```{r}

p = p + geom_boxplot(data=random_hotspot_data, aes(x=as.factor(hotspot_size), y=num_hotspots), color='red')

p

```



```{r}


top_hotspots = hotspot_info %>% group_by(hotspot_name) %>% summarize(sum_insertions = sum(hotspot_virus_tally)) %>% ungroup()

top_hotspots %>% arrange(desc(sum_insertions))


```



```{r}

 hotspot_info =  left_join(hotspot_info, top_hotspots, by='hotspot_name')

```


```{r}

hotspot_info %>% filter(sum_insertions >= 10) %>% 
  ggplot(aes(x=reorder(hotspot_name, -1*sum_insertions), y=hotspot_virus_tally, fill=virus_genome)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))
  


```



```{r}

hotspot_info %>% filter(sum_insertions >= 10) %>% 
  mutate(virus_genome = ifelse(grepl("HPV", virus_genome), "HPV", virus_genome)) %>%
  ggplot(aes(x=reorder(hotspot_name, -1*sum_insertions), y=hotspot_virus_tally, fill=virus_genome)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))
  

```


# Focus on significant hotspot sizes


```{r}

MIN_HOTSPOT_SIZE = 11

hotspot_info_top = hotspot_info %>% filter(sum_insertions >= MIN_HOTSPOT_SIZE) 

ordered_hotspot_names = hotspot_info_top %>% arrange(desc(sum_insertions)) %>% select(hotspot_name) %>% unique() %>% pull(hotspot_name)

hotspot_info_top$hotspot_name = factor(hotspot_info_top$hotspot_name, levels=ordered_hotspot_names)

hotspot_info_top %>% 
  #mutate(virus_genome = ifelse(grepl("HPV", virus_genome), "HPV", virus_genome)) %>%
  ggplot(aes(x=hotspot_name, y=hotspot_virus_tally, fill=virus_genome)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))




hotspot_by_virus_plot = hotspot_info_top %>% 
  mutate(virus_genome = ifelse(grepl("HPV", virus_genome), "HPV", virus_genome)) %>%
  ggplot(aes(x=hotspot_name, y=hotspot_virus_tally, fill=virus_genome)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

hotspot_by_virus_plot

```



```{r}
hotspots_of_interest = hotspot_info_top %>% select(hotspot) %>% unique() %>% pull(hotspot)



hotspot_insertion_seqtypes = left_join(hotspot_info_top %>% select(hotspot, hotspot_name),
                               hotspot_insertions %>% filter(hotspot %in% hotspots_of_interest) %>% select(hotspot, seqtype),
                               by='hotspot')


hotspot_seqtype_frac_info = hotspot_insertion_seqtypes %>% group_by(hotspot_name, seqtype) %>% tally() %>% mutate(pct=prop.table(n)) 

hotspot_seqtype_frac_info
```



```{r}

hotspot_seqtype_frac_info$hotspot_name = factor(hotspot_seqtype_frac_info$hotspot_name, levels=ordered_hotspot_names)


hotspot_by_seqtype_plot = hotspot_seqtype_frac_info %>% ggplot(aes(x=hotspot_name, y=pct, fill=seqtype)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

 hotspot_by_seqtype_plot 
  
```
  
  
```{r}
#  cohort representation

hotspot_insertion_cohorts = left_join(hotspot_info_top %>% select(hotspot, hotspot_name),
                               hotspot_insertions %>% filter(hotspot %in% hotspots_of_interest) %>% select(hotspot, cohort),
                               by='hotspot')


hotspot_cohort_frac_info = hotspot_insertion_cohorts %>% group_by(hotspot_name, cohort) %>% tally() %>% mutate(pct=prop.table(n)) 

hotspot_cohort_frac_info

  
```







```{r}


hotspot_cohort_frac_info$hotspot_name = factor(hotspot_cohort_frac_info$hotspot_name, levels=ordered_hotspot_names)


hotspot_cohort_frac_info %>% ggplot(aes(x=hotspot_name, y=pct, fill=cohort)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```




```{r}

#  cohort representation

hotspot_insertions = hotspot_insertions  %>% mutate(proj_name = ifelse(cohort=='TCGA', paste(cohort, project, sep="^"), cohort))


hotspot_insertion_projects = left_join(hotspot_info_top %>% select(hotspot, hotspot_name),
                               hotspot_insertions %>% filter(hotspot %in% hotspots_of_interest) %>% select(hotspot, proj_name),
                               by='hotspot')


hotspot_project_frac_info = hotspot_insertion_projects %>% group_by(hotspot_name, proj_name) %>% tally() %>% mutate(pct=prop.table(n)) 

hotspot_project_frac_info



```


```{r}


hotspot_project_frac_info$hotspot_name = factor(hotspot_project_frac_info$hotspot_name, levels=ordered_hotspot_names)


hotspot_by_project_plot = hotspot_project_frac_info %>% ggplot(aes(x=hotspot_name, y=pct, fill=proj_name)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

hotspot_by_project_plot

```



```{r}


pg = plot_grid(
          hotspot_by_seqtype_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_by_project_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_by_virus_plot, 
          ncol = 1, align='v',
          rel_heights=c(0.15, 0.15, 0.5))

pg
```

```{r}

ggsave(pg, file="top_hotspots_by_attributes.pdf", width=12, height=15)

```


# Incorporate expression and CNV info



```{r}
hotspot_info_top_with_insertions = left_join(hotspot_info_top %>% select(hotspot_name, hotspot) %>% unique(),
                                             insertion_hotspot_assignments %>% select(sample_id, contig, hotspot),
                                             by='hotspot'
                                             )

nrow(hotspot_info_top_with_insertions)
```

```{r}
# add insertion cnv info

cnv_info = read.table("../Insertion_and_CNVs/TCGA_insertions_and_CNV_within10kb", header=T, sep="\t", stringsAsFactors = F)  %>% unique()

```

```{r}

hotspot_info_top_with_insertions_and_CNV = left_join(hotspot_info_top_with_insertions, 
                                                     cnv_info,
                                                     by=c('sample_id'='sample', 'contig'='insertion') )

nrow(hotspot_info_top_with_insertions_and_CNV)

```


```{r}

# choose peak cnv copy number where multiple insertions analyzed for a single sample

hotspot_info_top_with_insertions_and_CNV = hotspot_info_top_with_insertions_and_CNV  %>% group_by(hotspot_name, sample_id) %>% arrange(desc(copy_number)) %>% filter(row_number()==1) %>% ungroup()


nrow(hotspot_info_top_with_insertions_and_CNV)
 
```

```{r}

hotspot_info_top_with_insertions_and_CNV$hotspot_name = factor(hotspot_info_top_with_insertions_and_CNV$hotspot_name, levels=ordered_hotspot_names)

```


```{r}

hotspot_cnv_boxplot = hotspot_info_top_with_insertions_and_CNV %>% ggplot(aes(x=hotspot_name, y=copy_number)) + geom_boxplot() +
  geom_hline(yintercept=2, linetype=2, color='purple') +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))


hotspot_cnv_boxplot 

```

# Incorporate expression effects

```{r}

insertion_expr_info = read.table("../Insertion_and_EXPR_effects/virus_insertions_unfiltered.10kb.expression_region_analysis.tsv", 
                                 header=T, sep="\t", stringsAsFactors = F) %>% unique()


nrow(insertion_expr_info)
```






```{r}

hotspot_info_top_with_insertions_and_CNV_and_EXPR = left_join(hotspot_info_top_with_insertions_and_CNV, 
                                                              insertion_expr_info %>% select(sample_id, contig, expr_quantile),
                                                              by=c('sample_id', 'contig'))

nrow(hotspot_info_top_with_insertions_and_CNV_and_EXPR)
```

```{r}

# take single highest expr quantile for sample,hotspot combo
hotspot_info_top_with_insertions_and_CNV_and_EXPR = hotspot_info_top_with_insertions_and_CNV_and_EXPR %>%
  group_by(hotspot_name, sample_id) %>% arrange(desc(expr_quantile)) %>% filter(row_number()==1) %>% ungroup()

nrow(hotspot_info_top_with_insertions_and_CNV_and_EXPR)

```



```{r}

hotspot_info_top_with_insertions_and_CNV_and_EXPR$hotspot_name = factor(hotspot_info_top_with_insertions_and_CNV_and_EXPR$hotspot_name, levels=ordered_hotspot_names)

```


```{r}

hotspot_expr_quantile_plot = hotspot_info_top_with_insertions_and_CNV_and_EXPR %>% ggplot(aes(x=hotspot_name, y=expr_quantile)) + geom_boxplot() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

hotspot_expr_quantile_plot
```



Interesting:  CESC-LP-A5U3-TP  has a couple of hotspots and expr effects:
 
chr17:39735144^ERBB2  19.7 cnv and 0.98 expr quantile
chr8:127790761^MYC~PVT1_1  3 cnv and 0.57 expr quantile


What other samples have multiple hotspot insertions?

```{r}
sample_ids_mult_hotspots = hotspot_info_top_with_insertions_and_CNV_and_EXPR %>% select(hotspot_name, sample_id) %>%  unique() %>%
  group_by(sample_id) %>% tally() %>% filter(n>1) %>% ungroup()
  
sample_ids_mult_hotspots
```

```{r}

hotspot_info_top_with_insertions_and_CNV_and_EXPR %>% filter(sample_id %in% sample_ids_mult_hotspots$sample_id) %>%
  select(sample_id, hotspot_name, copy_number, expr_quantile) %>% arrange(sample_id)

```



```{r}
# Bring all the plots together.

pg2 = plot_grid(
          hotspot_by_seqtype_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_by_project_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_cnv_boxplot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          hotspot_expr_quantile_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          hotspot_by_virus_plot, 
          ncol = 1, 
          align='v',
          axis='lr',
          rel_heights=c(0.15, 0.15, 
                        0.1,
                        0.1, 
                        0.5
                        ))

pg2
```

```{r}

ggsave(pg2, file="hotspot_summary_plot.pdf", width=20, height=15)



```




```{r}
# Bring all the plots together.

pg3 = plot_grid(
          #hotspot_by_seqtype_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          #hotspot_by_project_plot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
          hotspot_cnv_boxplot + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          hotspot_expr_quantile_plot, # + theme(axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()),
          #hotspot_by_virus_plot, 
          ncol = 1, align='v',
          rel_heights=c(#0.15, 0.15, 
                        0.2,
                        0.7#, 
                        #0.5
                        ))

pg3
```


# Compare sample representation among hotspots

```{r}

ordered_hotspot_insertions = hotspot_insertions %>% 
  select(hotspot, hotspot_sample_counts_redef_list) %>% unique() 

ordered_hotspot_insertions$hotspot_chromosome = sapply(ordered_hotspot_insertions$hotspot, function(x) {
  str_split(x, ":")[[1]][1]
} )

ordered_hotspot_insertions$hotspot_coord = sapply(ordered_hotspot_insertions$hotspot, function(x) {
  as.numeric(str_split(x, ":")[[1]][2])
} )

ordered_hotspot_insertions = ordered_hotspot_insertions %>% arrange(hotspot_chromosome, hotspot_coord)

n = nrow(ordered_hotspot_insertions)
lookback = 10

```

```{r}

# Are there similar sample compositions for neighboring hotspots suggesting that they should be combined into single hotspots?

MIN_J = 0.5

find_related_hotspots = function(x) {
  
  jaccard_pair_df = NULL
  
  index_row = ordered_hotspot_insertions[x,]
  index_row_sample_list = str_split(index_row$hotspot_sample_counts_redef_list, ",")
  
  
  for (i in seq(x-lookback+1, x-1)) {
    compare_row = ordered_hotspot_insertions[i,]
    compare_row_sample_list = str_split(compare_row, ",")
    
    u = union(index_row_sample_list, compare_row_sample_list)
    insect = intersect(index_row_sample_list, compare_row_sample_list)
    j = length(insect)/length(u)
    if (j >= MIN_J) {
      jaccard_pair_df = bind_rows(jaccard_pair_df, 
                                  data.frame(hotspot_A = index_row$hotspot, hotspot_B = compare_row$hotspot, j=j) )
    }
    
  }
  
  jaccard_pair_df
}

hotspot_sample_jaccard = do.call(bind_rows, lapply(seq(lookback, n, 1), find_related_hotspots))

#lapply(seq(lookback, 20, 1), find_related_hotspots)

hotspot_sample_jaccard

# nope

```





