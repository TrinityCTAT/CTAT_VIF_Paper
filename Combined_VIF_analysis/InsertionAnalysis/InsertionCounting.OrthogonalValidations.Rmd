---
title: "Counting Orthogonal Validations"
author: "bhaas"
date: '2023-03-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```



```{r}

filtered_insertions_data = read.table("all_insertions_and_virus_content_merged.FILTERED.tsv", header=T, sep="\t", stringsAsFactors = F)

```

```{r}

samples_in_rnaseq_and_other_seqtype = intersect(filtered_insertions_data %>% filter(seqtype == "RNA") %>% select(sample_name) %>% unique() %>% pull(sample_name),
                                               filtered_insertions_data %>% filter(seqtype != "RNA") %>% select(sample_name) %>% unique() %>% pull(sample_name) )


length(samples_in_rnaseq_and_other_seqtype )

```


# What fraction of insertion loci are actually shared between sample seqtypes?

```{r}

filtered_insertions_data = filtered_insertions_data %>% 
  mutate(coord_bin = round(human_coord / BINSIZE) ) %>% 
  mutate(insertion_locus = paste0(humanchr, "^", coord_bin)) %>% 
  select(-coord_bin)


```

```{r}

# restrict insertion loci to rna-seq having matched samples
insertion_loci = filtered_insertions_data %>% 
  filter(sample_name %in% samples_in_rnaseq_and_other_seqtype) %>%
  select(sample_name, insertion_locus, virus, seqtype) %>% unique()

```

```{r}

matching_insertions = read.table("rna_insertions_within_10kb_other_seqtype_insertions.tsv", header=T, sep="\t", stringsAsFactors = F) 
  
matching_insertions = matching_insertions %>%

  mutate(rna_coord_bin = round(rna_human_coord / BINSIZE)) %>%
  mutate(rna_insertion_locus = paste0(rna_humanchr, "^", rna_coord_bin)) %>%  
  
  mutate(other_coord_bin = round(human_coord / BINSIZE) ) %>% 
  mutate(other_insertion_locus = paste0(humanchr, "^", other_coord_bin)) %>% 
  
  select(-rna_coord_bin, -other_coord_bin)

matching_insertions = matching_insertions %>% filter(within_range) %>% select(sample_name, virus, rna_insertion_locus, seqtype, other_insertion_locus) %>% unique()

matching_insertions

```


```{r}

all_matching_insertion_loci = bind_rows(matching_insertions %>% select(sample_name, virus, insertion_locus = rna_insertion_locus) %>% 
                                          mutate( seqtype="RNA"),
                                        matching_insertions %>%
                                        select(sample_name, virus, insertion_locus = other_insertion_locus, seqtype) ) %>%
                                        unique()
                                      

```

```{r}

insertion_loci_valid_label = full_join(all_matching_insertion_loci %>% mutate(locus_orthogonally_validated = TRUE),
          insertion_loci,
          by=c('sample_name' ,'virus', 'insertion_locus', 'seqtype') ) %>% 
  mutate(locus_orthogonally_validated = ifelse(is.na(locus_orthogonally_validated), FALSE, locus_orthogonally_validated))

```


```{r}
# general stats on overall counts and proportions of validated insertion loci

num_insertion_loci_by_seqtype = insertion_loci_valid_label  %>%  group_by(seqtype) %>% tally(name='num_insertion_loci')

num_orthog_valid_by_seqtype = insertion_loci_valid_label  %>%  filter(locus_orthogonally_validated) %>% 
  group_by(seqtype) %>% tally(name='valid_insertion_loci')

orthog_valid_insertion_loci_stats = full_join(num_insertion_loci_by_seqtype,
                                              num_orthog_valid_by_seqtype,
                                              by='seqtype')

orthog_valid_insertion_loci_stats = orthog_valid_insertion_loci_stats %>% mutate(frac_loci_valid = valid_insertion_loci / num_insertion_loci)

orthog_valid_insertion_loci_stats

```



```{r}

# examine fraction validated per sample

insertion_loci_valid_label %>% group_by(sample_name, virus, seqtype, locus_orthogonally_validated) %>% tally() %>% mutate(pct=prop.table(n))


```


```{r}

samples_both_rnaseq_n_wxs = intersect(filtered_insertions_data %>% filter(seqtype == "RNA") %>% pull(sample_name),
                                      filtered_insertions_data %>% filter(seqtype == "WXS") %>% pull(sample_name)
                                    )
length(samples_both_rnaseq_n_wxs)
```


```{r}

insertion_loci_valid_label_fracs = insertion_loci_valid_label %>% filter(sample_name %in% samples_both_rnaseq_n_wxs) %>%
  group_by(sample_name, virus, seqtype, locus_orthogonally_validated) %>% tally() %>% mutate(pct=prop.table(n)) %>% ungroup()

insertion_loci_valid_label_fracs 

```

```{r}
insertion_loci_valid_label_fracs_spread = full_join(insertion_loci_valid_label_fracs %>% filter(locus_orthogonally_validated) %>% select(-locus_orthogonally_validated),
          insertion_loci_valid_label_fracs %>% filter(! locus_orthogonally_validated) %>% select(-locus_orthogonally_validated),
          by=c('sample_name', 'virus', 'seqtype'), 
          suffix=c('.true', '.false'))

insertion_loci_valid_label_fracs_spread[is.na(insertion_loci_valid_label_fracs_spread )] = 0

insertion_loci_valid_label_fracs_spread
```

```{r}

insertion_loci_valid_label_fracs_spread %>% ggplot(aes(x=reorder(sample_name, -1*pct.true), y=pct.true, fill=virus)) + geom_col() + facet_wrap(~seqtype)

```

```{r}

insertion_loci_valid_label_fracs_spread %>% 
  mutate(n.total = n.true + n.false) %>%
    ggplot(aes(x=n.total, y=pct.true, color=virus)) + geom_point() + facet_wrap(~seqtype, scale='free')

```

```{r}
insertion_loci_valid_label_fracs_spread %>% 
  mutate(n.total = n.true + n.false) %>%
    ggplot(aes(x=as.factor(n.total), y=pct.true, color=virus)) + geom_boxplot() + facet_wrap(~seqtype, scale='free', ncol=1)

```

```{r}
insertion_loci_valid_label_fracs_spread %>% filter(seqtype=="RNA")  %>% ggplot(aes(x=pct.true)) + geom_density()



```


