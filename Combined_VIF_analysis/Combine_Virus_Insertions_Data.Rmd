---
title: "Combinerd VIF analysis"
author: "bhaas"
date: '2023-01-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# aggregate virus content data

## TCGA

```{r}

# TCGA RNA-seq results for virus insertions
TCGA_rnaseq_virus_insertions = read.table("../TCGA_VIF_analysis/insertions.tsv", header=T, sep="\t", stringsAsFactors = F)

TCGA_rnaseq_virus_insertions$participant = str_replace(TCGA_rnaseq_virus_insertions$sample_name, "-[^\\-]+$", "")
TCGA_rnaseq_virus_insertions = TCGA_rnaseq_virus_insertions %>% rename(project=TCGA) %>% mutate(cohort="TCGA")

tcga_study_abbreviations = read.table("../TCGA_VIF_analysis/data/TCGA_study_abbreviations.txt", header=F, sep="\t", stringsAsFactors = F)
colnames(tcga_study_abbreviations) = c('project', 'tissue')

TCGA_rnaseq_virus_insertions = left_join(TCGA_rnaseq_virus_insertions, tcga_study_abbreviations, by='project')
TCGA_rnaseq_virus_insertions = TCGA_rnaseq_virus_insertions  %>% mutate(seqtype = "RNA")  %>% 
  mutate(tumor_or_normal = ifelse(grepl("^N", sample_type), "normal", "tumor") ) %>%
  select(-sample_type)

```


```{r}
# TCGA WGS results for virus content

TCGA_wgs_virus_insertions = read.table("../TCGA_VIF_analysis/TCGA_WGS_Analysis/insertions.tsv", header=T, sep="\t", stringsAsFactors = F)
TCGA_wgs_virus_insertions$participant = str_replace(TCGA_wgs_virus_insertions$sample_name, "-[^\\-]+$", "")
TCGA_wgs_virus_insertions = TCGA_wgs_virus_insertions %>% rename(project=TCGA) %>% mutate(cohort="TCGA")
TCGA_wgs_virus_insertions = left_join(TCGA_wgs_virus_insertions, tcga_study_abbreviations, by='project')
TCGA_wgs_virus_insertions = TCGA_wgs_virus_insertions  %>% mutate(seqtype = "WGS")  %>% 
  mutate(tumor_or_normal = ifelse(grepl("-N[^\\-]+$", sample_name), "normal", "tumor") ) 
```


```{r}
# TCGA WXS results for virus content

TCGA_wXs_virus_insertions = read.table("../TCGA_VIF_analysis/TCGA_WXS_Analysis/insertions.tsv", header=T, sep="\t", stringsAsFactors = F)
TCGA_wXs_virus_insertions$participant = str_replace(TCGA_wXs_virus_insertions$sample_name, "-[^\\-]+$", "")
TCGA_wXs_virus_insertions = TCGA_wXs_virus_insertions %>% rename(project=TCGA) %>% mutate(cohort="TCGA")
TCGA_wXs_virus_insertions = left_join(TCGA_wXs_virus_insertions, tcga_study_abbreviations, by='project')
TCGA_wXs_virus_insertions = TCGA_wXs_virus_insertions  %>% mutate(seqtype = "WXS")  %>% 
  mutate(tumor_or_normal = ifelse(grepl("-N[^\\-]+$", sample_name), "normal", "tumor") ) %>%  
  select(-sample_type)
```


```{r}

TCGA_combined_virus_insertions = bind_rows(TCGA_rnaseq_virus_insertions,
                                        TCGA_wgs_virus_insertions,
                                        TCGA_wXs_virus_insertions
                                        )

```


## TARGET pediatric 

```{r}

TARGET_rnaseq_virus_insertions = read.table("../TARGETdb_VIF_analysis/insertions.tsv", header=T, sep="\t", stringsAsFactors = F)

TARGET_rnaseq_virus_insertions = TARGET_rnaseq_virus_insertions %>% mutate(cohort='TARGET', seqtype='RNA') %>%
  mutate(tumor_or_normal = ifelse(grepl("tumor", project), "tumor", "normal")) %>%
  rename(tissue=sample_type)

```

## GTEx

```{r}

GTEx_rnaseq_virus_insertions = read.table("../GTEx_VIF_analysis/insertions.tsv", header=T, sep="\t", stringsAsFactors = F)
GTEx_rnaseq_virus_insertions$participant = sapply(GTEx_rnaseq_virus_insertions$sample_name, function(x) { str_split(x, "-")[[1]][2]})
GTEx_rnaseq_virus_insertions = GTEx_rnaseq_virus_insertions %>% 
  mutate(cohort='GTEx', seqtype='RNA', project=tissue_id, tumor_or_normal='normal') %>% 
  rename(tissue = tissue_id)

```

## CCLE

```{r}

# CCLE rna-seq virus content
CCLE_rnaseq_virus_insertions = read.table("../CCLE_VIF_analysis/insertions.tsv", header=T, sep="\t", stringsAsFactors = F) 
  
CCLE_rnaseq_virus_insertions = CCLE_rnaseq_virus_insertions %>% 
  mutate(participant=sample_name, seqtype='RNA', cohort='CCLE', project='CCLE', tumor_or_normal='tumor_cell_line') %>%
  rename(tissue=tissue_id)

CCLE_rnaseq_virus_insertions$sample_name =  sapply(CCLE_rnaseq_virus_insertions$sample_name, function(x) {str_split(x, "_")[[1]][1] })

```



```{r}
# CCLE WXS

CCLE_wXs_virus_insertions = read.table("../CCLE_VIF_analysis/CCLE_WXS_analysis/insertions.tsv", 
                                    header=T, sep="\t", stringsAsFactors = F)

CCLE_wXs_virus_insertions = CCLE_wXs_virus_insertions %>% 
  mutate(participant=sample_name, seqtype='WXS', cohort='CCLE', project='CCLE', tumor_or_normal='tumor_cell_line') %>%
  select(-bundled_sample_name) %>%
  rename(tissue=tissue_id)

CCLE_wXs_virus_insertions$sample_name =  sapply(CCLE_wXs_virus_insertions$sample_name, function(x) {str_split(x, "_")[[1]][1] })

```

```{r}
# combine CCLE virus content data

CCLE_combined = bind_rows(CCLE_rnaseq_virus_insertions,
                          CCLE_wXs_virus_insertions)

CCLE_combined = CCLE_combined %>% mutate(sample_name = ifelse(sample_name == "TT", participant, sample_name))

```



## Nat Genetics 2015 hyb capture

```{r}

NATGEN2015_hybcap_virus_insertions = read.table("../NatGenetics2015_reanalysis/NatGenetics2015_VIF/insertions.tsv", 
                                             header=T, sep="\t", stringsAsFactors = F)

NATGEN2015_hybcap_virus_insertions = NATGEN2015_hybcap_virus_insertions %>% 
  rename(seqtype = sample_type) %>%
  mutate(cohort="NATGEN2015") %>% 
  mutate(project="NATGEN2015") %>%
  mutate(tumor_or_normal = "tumor") %>%
  mutate(tissue = "cervical", sample_type = "cervical") %>%
  mutate(seqtype = ifelse(seqtype == 'hivid', 'HYB', seqtype)) %>%
  mutate(seqtype = ifelse(seqtype == 'rnaseq', 'RNA', seqtype)) %>%
  mutate(seqtype = ifelse(seqtype == 'wgs', 'WGS', seqtype)) %>%
  mutate(participant = sample_label_short) %>% 
  select(-sra_num_reads, -sample_label, -sample_label_short)


NATGEN2015_hybcap_virus_insertions = NATGEN2015_hybcap_virus_insertions %>% mutate(tumor_or_normal = ifelse(participant %in% c('CASKID', 'S12', 'SIHA', 'HELA'), "tumor_cell_line", tumor_or_normal))


```

## Combine all
```{r}

combined_all_virus_insertions = bind_rows(TCGA_combined_virus_insertions,
                                       TARGET_rnaseq_virus_insertions,
                                       GTEx_rnaseq_virus_insertions,
                                       CCLE_combined,
                                       NATGEN2015_hybcap_virus_insertions)

```

```{r}

combined_all_virus_insertions$tissue = str_replace_all(combined_all_virus_insertions$tissue, " ", "_")


```


```{r}
# rename common viruses and deal with EBV strain issue


combined_all_virus_insertions = combined_all_virus_insertions %>% 
  mutate(virus = ifelse(virus=="NC_007605_171823nt_Human_gammaherpesvirus_4" | virus == "NC_009334_172764nt_Human_herpesvirus_4_type_2", "Eppstein-Barr", virus)) %>%
                                         mutate(virus = ifelse(virus=="NC_003977_3182nt_Hepatitis_B_virus", "HBV", virus))

nrow(combined_all_virus_insertions)


```



```{r}

combined_all_virus_insertions = combined_all_virus_insertions %>%
  mutate(sample_id = sample_name) %>%
  mutate(sample_name = paste(participant, project, tumor_or_normal, sep="^"))
  

```


```{r}

write.table(combined_all_virus_insertions, file="virus_insertions_unfiltered.tsv", sep="\t", quote=F, row.names=F)
```








